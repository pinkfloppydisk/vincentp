---
layout: "post"
title: "Implementing the Indieweb using a static server and Netlify"
date: "2018-11-12 12:00:00 +/-GMT"
meta:  "Implementing the Indieweb using a static server"
summary: "Implementing the Indieweb using a static server"
category: "Articles"
modified :
modifiedReason:
twitterCard: true
tags: "indieweb jekyll thoughts technology webmention"
---

## Jump to the main things

- [Basic theory](#basic-theory)
- [Micropub](#micropub)
- [Backfeed](#backfeed)
- [Receiving Webmentions](#receiving-webmentions)
- [Formatting received Webmentions](#formatting-and-storing-webmentions-for-a-static-site)
- [Sending Webmentions](#sending-webmentions)

## IndieWeb

The [IndieWeb](https://indieweb.org/){:rel="external"} is a collection of web technologies actively being worked on to share content between websites and break out from the silo'ed social design you may be [familiar](https://www.twitter.com){:rel="external"} [with](https://facebook.com){:rel="external"}.

All you need to join the [IndieWeb](https://indieweb.org/){:rel="external"} is a Website and a URL then you can get involved. In fact, If you run your blog on a common platform such as [Wordpress](https://www.wordpress.org){:rel="external"}, you might even find that it is already supported.

This post focuses on how I implemented the following collection of IndieWeb technologies on my static site.

- <abbr title="Post Own Site Syndicate Elsewhere">POSSE</abbr>[^1]
- <abbr title="Post Elsewhere Syndicate Own Site">PESOS</abbr>[^2]
- Webmention[^3]

## Basic theory

I like to keep things simple. It's no secret that IndieWeb technologies can get complicated. I decided that all approaches must respect my current blog pattern.

1. Post a file in to Github.
2. Posting a file will cause the [Netlify](https://netlify.com){:rel="external"} Webhook[^4] to activate and pull the code on to their servers which causes a rebuild and deploy.
3. Avoid client-side JavaScript. Everything is supposed to be static, lets keep it that way. It's less complicated to cache for Service Workers and reduces potential errors.
4. Platform agnostic. I don't want any logic responsible for IndieWeb technologies tied together with my blogging platform. Blogs are in markdown to keep them portable to any platform, so let's keep it that way.

With this format decided it becomes clear that another actor is required.

The blog has no real dynamic aspect other than templates. Thus we need something that captures the data, transforms it in to what we need and pushes it in to the Github API. Upon pushing the content in to the Github API, this will trigger a rebuild and deploy the site cleanly with no intermediate action needed. Nice!

I am most comfortable with [Node.JS](https://nodejs.org/){:rel="external"} (but the techniques I am going to describe can work in most languages) so I [spun up an IndieWeb server](https://mastr-cntrl.herokuapp.com){:rel="external"} on [Heroku](https://www.heroku.com){:rel="external"}. The very knowledgable [Phil Hawksworth](https://www.hawksworx.com/about){:rel="external"} pointed out recently I could possibly port this code to [Lambda](https://www.netlify.com/blog/2018/03/20/netlifys-aws-lambda-functions-bring-the-backend-to-your-frontend-workflow/){:rel="external"} functions and remove the Heroku dependency entirely. It's on the list for a future update and I would love to hear what other people think of this approach.

## Microformats

Before we delve deep in to the code its worth noting a few more important things. The IndieWeb is heavily dependant upon [Microformats](http://microformats.org){:rel="external"} and properly formed HTML. It is these tags it uses to work out what code is related to what. So spend time marking up your code correctly and read the [Indieweb Getting started guide](https://indieweb.org/Getting_Started){:rel="external"}. In particular focus on [h-card](http://microformats.org/wiki/h-card){:rel="external"} and [h-entry](http://microformats.org/wiki/h-entry){:rel="external"}.

## Security

One last note on security. If you are opening up your website to code from an external source make sure you can only let in the code you want. If a bad actor discovers your endpoint and can submit content easily they might spam your website and no one wants that.

Luckily the smart IndieWeb folk have thought of the first point, so make sure in all your dealings with external sources you use [IndieAuth](https://indieauth.com){:rel="external"}. You will see me mention IndieAuth a few times below. Get familiar with it and how it handles the token request. It's important you get this right.

It's also good practice to rate limit your endpoint. Since our IndieWeb server is a separate Microservice[^5] to our website we don't have to worry about a bad actor bringing our blog down, however we still need to protect our IndieWeb server from harm.

Finally. Don't store any of your keys in anything that can be traced such as Github. Learn about environmental variables and use something such as [dotenv](https://github.com/motdotla/dotenv#readme){:rel="external"}  to manage them.

## Micropub

Before you start, don't forget to add the correct meta tags to your blog home page. You need one for your authorisation endpoint, one for your token endpoint and one to point to your Micropub endpoint.

You can see I am using IndieAuth as my token and authorisation provider. It's the quickest way to get up and running but there are other options if you prefer them.

Here are my tags below as an example. Every time a service hits my website looking for how to send me Micropub content these tags tell it where to go and what to do. You can view source on my page and look in the header for a detailed example.

```html
<link rel="authorization_endpoint" href="https://indieauth.com/auth" />
<link rel="token_endpoint" href="https://tokens.indieauth.com/token" />
<link rel="micropub" href="https://mastr-cntrl.herokuapp.com/micropub" />
```

<blockquote>
    <p>Micropub is an open API standard (W3C Recommendation) that is used to create, update, and delete posts on one's own domain using third-party clients, and supersedes both MetaWeblog and AtomPub.</p>
    <p>Web apps and native apps (e.g. iPhone, Android) can use Micropub to post and edit articles, short notes, comments, likes, photos, events, or other kinds of posts to your own site.</p>
    <footer>
       <cite><a href="https://indieweb.org/Micropub" rel="external">IndieWeb Wiki</a></cite>
    </footer>
</blockquote>

Put simply you can write a blog post on another authorised platform and submit it in to your website. This includes attached media, such as images. Finally the content injected in to your website can be optionally syndicated to other platforms with your blog post being the originator.

You can read the [W3C spec](https://www.w3.org/TR/micropub/){:rel="external"} if you want to dig deeper.

That's quite a lot of concepts. Lets break it down.

1. I can log in to an IndieWeb authorised (and trusted) platform such as [Quill](http://quill.p3k.io/){:rel="external"}.
2. Once logged in using IndieAuth I can write a blog post.
3. At the point of logging in, the platform will also look for a media endpoint and syndication targets.
4. This content is POST'ed to your micropub endpoint usually in JSON.
5. Once your micropub endpoint verifies the Token and accepts the content it parses the JSON body and formats accordingly.
6. If the content sent specifies a media endpoint your server will need to handle the request and upload the images sequentially "somewhere".
7. If the content sent specifies syndication your server will need to handle POST'ing that content to the respective source or API.
8. In my case the content is then Base64 encoded and POST'ed in to the Github API, causing a rebuild and deploy. Although you may handle this last step differently depending upon your implementation.

Here is the basic flow my Micropub endpoint takes. In terms of where the "smart stuff" happens. This is all happening in Mastr-Cntrl[^8]. It captures the data, formats it then POST's it in to the Github API. What keeps this "clean" is following the process as if we had coded the page by hand and committed it using Git[^9].

{% include diagrams/micropub-flow.html %}

### Media endpoint

Not essential, but useful if you want to own your imagery.

If this isn't included a link may be included in the JSON to the original image by the provider,  or you may have to add images manually to your post later.

### Syndication endpoint

If this isn't included then you will not be able to syndicate to other targets at the same time on publish. You could do this manually later. While I was building my own endpoint, I cheated by using a Zapier Zap that watched a custom RSS (ATOM) feed. When a new item appeared it syndicated the content to Twitter or Medium.

According to the W3C specification you need to declare these in the following way:

```javascript
GET /micropub?q=config
Authorization: Bearer xxxxxxxxx
Accept: application/json

HTTP/1.1 200 OK
Content-type: application/json

{
  "media-endpoint": "https://media.example.com/micropub",
  "syndicate-to": [
    {
      "uid": "https://myfavoritesocialnetwork.example/aaronpk",
      "name": "aaronpk on myfavoritesocialnetwork",
      "service": {
        "name": "My Favorite Social Network",
        "url": "https://myfavoritesocialnetwork.example/",
        "photo": "https://myfavoritesocialnetwork.example/img/icon.png"
      },
      "user": {
        "name": "aaronpk",
        "url": "https://myfavoritesocialnetwork.example/aaronpk",
        "photo": "https://myfavoritesocialnetwork.example/aaronpk/photo.jpg"
      }
    }
  ]
}
```

What this is telling you, is that your server needs to respond to a GET request on a ```\micropub``` endpoint when the parameter ```q=config``` is passed with a JSON file that specifies your media-endpoint destination and your social network profiles.

Note that in order for the endpoint to return anything, you must have first authorised the request using IndieAuth.

## Backfeed

<blockquote>
    <p>Backfeed is the process of syndicating interactions on your POSSE copies back (AKA reverse syndicating) to your original posts.</p>
    <footer>
       <cite><a href="https://indieweb.org/backfeed" rel="external">IndieWeb Wiki</a></cite>
    </footer>
</blockquote>

I currently use Backfeed via [ownyourswarm](https://ownyourswarm.p3k.io){:rel="external"} and [ownyourgram](https://ownyourgram.com){:rel="external"} to syndicate content from those service back on to my website.

Backfeeding via these services works exactly the same as using Micropub. The content is automatically published to your site a few moments after posting. If you are using [Swarm](http://swarmapp.com/){:rel="external"} badges and comments are sent as Webmentions. Neat!

The great thing about controlling your own content is that you can display it how you wish. For example, in [this checkin](https://vincentp.me/checkins/2018/11/05/08-50/) I took a photo, so I can make it the focus of the post, but in [this checkin](https://vincentp.me/checkins/2018/09/25/19-18/) I didn't take a photo so instead I generate a static map image from [Mapbox](https://www.mapbox.com/){:rel="external"} using the Longitude and Latitude data.

A quick note if you live in Europe around Backfeeding Webmentions via [Brid.gy](http://brid.gy){:rel="external"}[^6]. [There may be GDPR implications](https://sebastiangreger.net/2018/05/indieweb-privacy-challenge-webmentions-backfeeds-gdpr/){:rel="external"}. I am avoiding this practice in the short term, and only publishing Webmentions sent to me directly to ensure intent that the content should be displayed on my website.

## Formatting a Micropub post

Once we have got our content we need to map it in to a file, assign it the correct template, and save it as a markdown file.

In Mastr-Cntrl[^8] I use a formatter for each type. [Here is an example of how I format a Note](https://github.com/vipickering/mastr-cntrl/blob/master/app/functions/format-note.js){:rel="external"}.

Currently I have commented out photos. This is because my media endpoint code is still not finished, once it's done I'll update the post. In the meantime I can comment it out and side-step using photos. It's fun to note that you can slowly build up your confidence with your Micropub endpoint. I've barely touched on a tiny amount of functionality it can perform. As I get more confident I expand what my formatter excepts and how I will capture and transform that data.

The formatter maps the JSON received to a variable and does a try catch to see if it exists. If it does it is added in to the Front-matter[^7] for the markdown file. This continues to capture all the blog post data in one place while keeping things agnostic.

Other things to note. Because my method involves POST'ing a markdown file in to the Github API, I need to base64 encode the file. This is a requirement of working with the [Github API](https://developer.github.com/v3/){:rel="external"}. It's worth familiarising yourself with the API if you want to use this method, otherwise it is not necessary for your implementation.

For day to day usage posting notes I have been using [Indigenous](https://indieweb.org/Indigenous){:rel="external"} (iOS/Android) by [Eddie Hinkle](https://eddiehinkle.com/){:rel="external"} . Which also has an IndieWeb Microsub[^10] reader built in. It's a great workflow that I really like.

## Receiving Webmentions

First we need to tell Webmention services where our Webmention endpoint is.

Here is mine as an example.

```html
<link rel="webmention" href="https://webmention.io/vincentp.me/webmention" />
```

Notice I am **not** pointing this at Mastr-Cntrl[^8]. Instead I am pointing this at the free Webmention service [Webmention.io](https://webmention.io){:rel="external"}.

The reason I am doing this is because capturing Webmentions, filtering out Spam and parsing web pages is tricky business. Webmention.io handles all the hard stuff then captures my Webmentions, holding on to them temporarily. There is an API you can manually fetch from, or you can add a secret token and your Webmention endpoint in the dashboard (once you have an account) causing the service to automatically POST you the data once it receives it. Which is what I do.

This is my basic flow for receiving Webmentions using a static site and [Github](https://github.com){:rel="external"} with [Netlify](https://netlify.com){:rel="external"} set-up.

{% include diagrams/receiving-webmentions-flow.html %}

In this flow the "magic" happens in the same fashion as my Micropub process. The IndieWeb server captures the data and formats it, then POST's it in to the Github API. This triggers a rebuild and deploy of the site containing the new data.

The difference here is that I am storing the data in a JSON file in the [data folder for Jekyll](https://jekyllrb.com/docs/step-by-step/06-data-files/){:rel="external"} and my Webmentions are managed by [Webmention.io](https://webmention.io){:rel="external"} a free service to handle receiving Webmentions.

## Formatting and storing Webmentions for a static site

## Sending Webmentions

{% include diagrams/sending-webmentions-flow.html %}

how it works etc.

## Useful IndieWeb Services

- Quill
-
-



## Always more to do

- Storing Webmentions in one <abbr title="JavaScript Object Notation">JSON</abbr> file over time will cause build times to grow. It might be better to store Webmentions in a flat file alongside the post. I am still working on this solution, feel free to send your replies!
- Implement syndication the same as sending Webmentions.
- I would like to port the code over to Lambda functions in the future and remove the Heroku dependency.
- Moving to Eleventy next, this may change my implementation in some key ways. I'll update this post if that is the case.
- [IndieWeb Reader](https://indieweb.org/reader){:rel="external"}. This is my ultimate aim. I never stopped using feeds to consume content and have stuck with them. The IndieWeb Reader is bringing feeds back! I need to re-design my homepage to enrich my content through an indieweb reader.
- Content Sharding.

<div class="f-mono black f7 ttu" data-type="notes"><span>Notes</span></div>
[^1]: [POSSE](https://indieweb.org/POSSE){:rel="external"} Publish (on your) Own Site, Syndicate Elsewhere".
[^2]: [PESOS](https://indieweb.org/PESOS){:rel="external"} Publish Elsewhere, Syndicate (to your) Own Site".
[^3]: [Webmention](https://indieweb.org/Webmention){:rel="external"} is a web standard for mentions and conversations across the web".
[^4]: [Microservices](https://zapier.com/blog/what-are-webhooks/){:rel="external"} are an architectural style that structures an application as a collection of loosely coupled services, rather than one monolithic service.
[^5]: A [Webhook](https://en.wikipedia.org/wiki/Microservices){:rel="external"} is a way your website can communicate with another to prompt and action or share information.
[^6]: [Brid.gy](http://brid.gy){:rel="external"} is one way your website can Backfeed comments from other social networks that link to your post and aggregate them in one place.
[^7]: [Frontmatter](https://jekyllrb.com/docs/front-matter/){:rel="external"} is formatted data specific to the file it is in.
[^8]: [Mastr-Cntrl](https://github.com/vipickering/mastr-cntrl){:rel="external"} is my IndieWeb server. Responsible for Micropub and Webmentions.
[^9]: [Git](https://git-scm.com){:rel="external"} is a free and open source distributed version control system.
[^10]: [Microsub](https://indieweb.org/Microsub){:rel="external"} provides a standardized way for reader apps to interact with feeds.
