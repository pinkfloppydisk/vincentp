{% if site.webmentionTestUrl == false %}
    {% assign thisUrl =  page.url | absolute_url %}
{% else %}
    {% assign thisUrl =  "https://vincentp.me" | append: page.url %}
{% endif %}

{% assign dateDay = page.date | date: "%d" %}
{% assign dateMonth = page.date | date: "%m" %}
{% assign dateYear = page.date | date: "%Y" %}

{% assign repostsCount = 0 %}
{% assign likesCount = 0 %}
{% assign replyCount = 0 %}
{% assign mentionCount = 0 %}
{% assign bookmarkCount = 0 %}
{% assign rsvpCount = 0 %}

{% assign webmentions = site.data.webmention %}

{% for yearLoop in webmentions %}
    {% for monthLoop in yearLoop[1] %}
        {% for dayLoop in monthLoop[1] %}
            {% for mention in dayLoop[1] %}
                {% case mention[1].wm-property %}
                    {% when 'in-reply-to' %}
                        {% if thisUrl == mention[1].in-reply-to %}
                            {% assign replyCount = replyCount | plus: 1 %}
                        {% endif %}
                    {% when 'like-of' %}
                        {% if thisUrl == mention[1].like-of %}
                            {% assign likesCount = likesCount | plus: 1 %}
                        {% endif %}
                    {% when 'mention-of' %}
                        {% if thisUrl == mention[1].mention-of %}
                            {% assign mentionCount = mentionCount | plus: 1 %}
                        {% endif %}
                     {% when 'repost-of' %}
                        {% if thisUrl == mention[1].repost-of %}
                            {% assign repostsCount = repostsCount | plus: 1 %}
                        {% endif %}
                    {% when 'bookmark-of' %}
                        {% if thisUrl == mention[1].bookmark-of %}
                             {% assign bookmarkCount = bookmarkCount | plus: 1 %}
                        {% endif %}
                    {% when 'rsvp' %}
                        {% if thisUrl == mention[1].rsvp %}
                             {% assign rsvpCount = rsvpCount | plus: 1 %}
                        {% endif %}
                    {% else %}
                {% endcase %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
{% endfor %}

{% if likesCount > 0 and page.disableWebmention != true %}
    <h3>Likes</h3>
    {% for yearLoop in webmentions %}
        {% for monthLoop in yearLoop[1] %}
            {% for dayLoop in monthLoop[1] %}
                {% for mention in dayLoop[1] %}
                    {% if thisUrl == mention[1].like-of %}
                    <div class="p-like h-cite dib">
                        <a href="{{mention[1].url}}" class="u-url">
                            <span class="p-author h-card">
                                <img width="30" height="30" src="{{mention[1].author.photo }}" alt="{{mention[1].author.name }}" class="u-photo pa-fixed-1 br-circle b-light-grey ba bg-white">
                            </span>
                        </a>
                    </div>
                   {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
{% endif %}


{% if replyCount > 0 and page.disableWebmention != true %}
<h3>Replies</h3>
    {% for yearLoop in webmentions %}
        {% for monthLoop in yearLoop[1] %}
            {% for dayLoop in monthLoop[1] %}
                {% for mention in dayLoop[1] %}
                    {% if thisUrl == mention[1].in-reply-to %}
                    <div class="p-comment h-cite mb5">
                        <h3 class="p-author h-card dg ma0 pa0 webmention-mini-two-col-grid"><img width="30" height="30" src="{{mention[1].author.photo }}" alt="{{mention[1].author.name }}" class="u-photo pa-fixed-1 br-circle avatar-stack b-light-grey ba bg-white"> <a href="{{mention[1].author.url}}" class="p-name u-url f5 red ma0 pa0 rm-underline" rel="external">{{mention[1].author.name}}</a></h3>
                        <div class="e-content p-name">{{mention[1].content.text}}</div>
                        <time class="dt-published db f7" datetime="{{mention[1].published | date_to_xmlschema}}"><a href="{{mention[1].url}}" class="grey  rm-underline " rel="external">{{ mention[1].published | date_to_string: "ordinal" }} <span>at</span> {{ mention[1].published | date: "%H" }}:{{ mention[1 ].published | date: "%M%P" }}</a></time>
                    </div>
                   {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
{% endif %}

{% if bookmarkCount > 0 and page.disableWebmention != true %}
<h3>Bookmarks</h3>
    {% for yearLoop in webmentions %}
        {% for monthLoop in yearLoop[1] %}
            {% for dayLoop in monthLoop[1] %}
                {% for mention in dayLoop[1] %}
                    {% if thisUrl == mention[1].bookmark-of %}
                    <div class="p-bookmark h-cite dib">
                        <a href="{{mention[1].url}}" class="u-url">
                            <span class="p-author h-card">
                                <img width="30" height="30" src="{{mention[1].author.photo }}" alt="{{mention[1].author.name }}" class="u-photo pa-fixed-1 br-circle b-light-grey ba bg-white">
                            </span>
                        </a>
                    </div>
                   {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
<p class="h-cite p-comment reply-relation mb2 f6">{{bookmarkCount}} Bookmarks</p>
{% endif %}

{% if repostsCount > 0 and page.disableWebmention != true %}
    <h3>Reposts</h3>
    {% for yearLoop in webmentions %}
        {% for monthLoop in yearLoop[1] %}
            {% for dayLoop in monthLoop[1] %}
                {% for mention in dayLoop[1] %}
                    {% if thisUrl == mention[1].repost-of %}
                       <div class="p-repost h-cite dib">
                        <a href="{{mention[1].url}}" class="u-url">
                            <span class="p-author h-card">
                                <img width="30" height="30" src="{{mention[1].author.photo }}" alt="{{mention[1].author.name }}" class="u-photo pa-fixed-1 br-circle b-light-grey ba bg-white">
                            </span>
                        </a>
                    </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
<p class="h-cite p-comment reply-relation mb2 f6">{{repostsCount}} Reposts</p>
{% endif %}
